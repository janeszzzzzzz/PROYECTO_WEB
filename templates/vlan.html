<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Administración VLAN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-5">

    <h1 class="mb-4 text-center">Panel Profesional de VLAN</h1>

    <!-- Card de Escaneo -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h4>Escanear Red</h4>

            <div class="row mb-3">
                <div class="col">
                    <label>IP inicial</label>
                    <input id="ip_inicio" class="form-control" placeholder="192.168.1.1">
                </div>

                <div class="col">
                    <label>Usuario</label>
                    <input id="usuario" class="form-control">
                </div>

                <div class="col">
                    <label>Contraseña</label>
                    <input id="contrasena" type="password" class="form-control">
                </div>
            </div>

            <button class="btn btn-primary" onclick="escanear()">Iniciar Escaneo</button>

            <div class="mt-3" id="scan_status"></div>
        </div>
    </div>

    <!-- Card de Lista de hosts -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <h4>Hosts encontrados</h4>
            <small>Selecciona un host para gestionar su VLAN</small>

            <select id="lista_hosts" class="form-select mt-2" onchange="cargarHost()">
                <option value="">-- Sin datos aún --</option>
            </select>
        </div>
    </div>

    <!-- Card de Detalles del host -->
    <div class="card shadow mb-4">
        <div class="card-body">

            <h4>Datos del host seleccionado</h4>

            <p><strong>Switch:</strong> <span id="detalle_switch">---</span></p>
            <p><strong>IP del Switch:</strong> <span id="detalle_ip_sw">---</span></p>
            <p><strong>Puerto:</strong> <span id="detalle_puerto">---</span></p>
            <p><strong>VLAN actual:</strong> <span id="detalle_vlan">---</span></p>

            <div class="mt-4">
                <label>Nueva VLAN:</label>
                <input id="nueva_vlan" class="form-control" placeholder="Ej. 10, 20, 30...">
            </div>

            <button class="btn btn-success mt-3" onclick="cambiarVLAN()">Aplicar cambio</button>

            <pre id="resultado" class="mt-3"></pre>
        </div>
    </div>

</div>

<script>

let inventario = {}; // Aquí guardamos todo el escaneo

// =============================
//       ESCANEAR RED
// =============================
// function escanear() {

//     document.getElementById("scan_status").innerHTML = "⏳ Escaneando...";

//     fetch("/api/escanear", {
//         method: "POST",
//     //     headers: {"Content-Type": "application/json"},
//     //     body: JSON.stringify({
//     //         ip_inicio: document.getElementById("ip_inicio").value,
//     //         usuario: document.getElementById("usuario").value,
//     //         contrasena: document.getElementById("contrasena").value
//     //     })
//     body: JSON.stringify({
//     ip: document.getElementById("ip_inicio").value,
//     usuario: document.getElementById("usuario").value,
//     contrasena: document.getElementById("contrasena").value
// })


        
//     })
//     .then(r => r.json())
//     .then(data => {
//         inventario = data;
//         document.getElementById("scan_status").innerHTML = "✔ Escaneo completado";

//         llenarListaHosts();
//     });
// }

function escanear() {
    document.getElementById("scan_status").innerHTML = "⏳ Escaneando...";

    fetch("/api/escanear", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            ip: document.getElementById("ip_inicio").value,   // <-- llave "ip"
            usuario: document.getElementById("usuario").value,
            contrasena: document.getElementById("contrasena").value
        })
    })
    .then(r => {
        if (!r.ok) throw new Error(`Server error ${r.status}`);
        return r.json();
    })
    .then(data => {
        inventario = data;
        document.getElementById("scan_status").innerHTML = "✔ Escaneo completado";
        llenarListaHosts();
    })
    .catch(err => {
        document.getElementById("scan_status").innerHTML = "❌ Error: " + err.message;
    });
}

// =============================
//       LLENAR LISTA HOSTS
// =============================
function llenarListaHosts() {

    let select = document.getElementById("lista_hosts");
    select.innerHTML = "";

    let total = 0;

    for (let sw in inventario) {
        for (let h of inventario[sw]) {
            let opt = document.createElement("option");
            opt.value = JSON.stringify(h);
            opt.textContent = `${h.ip} | ${h.mac} | ${h.puerto} (${sw})`;
            select.appendChild(opt);
            total++;
        }
    }

    if (total === 0) {
        select.innerHTML = "<option>No se encontraron hosts</option>";
    }
}


// =============================
//     MOSTRAR DETALLES HOST
// =============================
function cargarHost() {

    let texto = document.getElementById("lista_hosts").value;
    if (!texto) return;

    let h = JSON.parse(texto);

    document.getElementById("detalle_switch").textContent = h.switch;
    document.getElementById("detalle_ip_sw").textContent = h.ip_sw;
    document.getElementById("detalle_puerto").textContent = h.puerto;
    document.getElementById("detalle_vlan").textContent = h.vlan;
}


// =============================
//         CAMBIAR VLAN
// =============================
// function cambiarVLAN() {

//     let texto = document.getElementById("lista_hosts").value;
//     if (!texto) {
//         alert("Selecciona un host primero");
//         return;
//     }

//     let h = JSON.parse(texto);

//     fetch("/api/cambiar_vlan", {
//         method: "POST",
//         headers: {"Content-Type": "application/json"},
//         body: JSON.stringify({
//             ip: h.ip,
//             vlan: document.getElementById("nueva_vlan").value,
//             usuario: document.getElementById("usuario").value,
//             contrasena: document.getElementById("contrasena").value
//         })
//     })
//     .then(r => r.json())
//     .then(data => {
//         document.getElementById("resultado").textContent =
//             JSON.stringify(data, null, 2);
//     });

// }
function cambiarVLAN() {
    let texto = document.getElementById("lista_hosts").value;
    if (!texto) {
        alert("Selecciona un host primero");
        return;
    }

    let h = JSON.parse(texto);

    fetch("/api/cambiar_vlan", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            ip: h.ip,
            vlan: document.getElementById("nueva_vlan").value,
            usuario: document.getElementById("usuario").value,
            contrasena: document.getElementById("contrasena").value
        })
    })
    .then(r => {
        if (!r.ok) return r.json().then(j => Promise.reject(j));
        return r.json();
    })
    .then(data => {
        // muestra la stdout devuelta por el servidor
        document.getElementById("resultado").textContent =
            data.stdout || JSON.stringify(data, null, 2);
    })
    .catch(err => {
        document.getElementById("resultado").textContent =
            typeof err === "object" ? JSON.stringify(err, null, 2) : String(err);
    });
}

</script>

</body>
</html>
